---
import BaseLayout from './BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import PersonSchema from '../components/schemas/PersonSchema.astro';

export interface Props {
  title: string;
  description: string;
  date: string;
  dateModified?: string;
  canonical: string;
  ogImage?: string;
  keywords?: string[];
  category?: string;
  tags?: string[];
  readingTime?: string;
  relatedLinks?: Array<{ title: string; url: string; type?: string }>;
}

const {
  title,
  description,
  date,
  dateModified,
  canonical,
  ogImage,
  keywords = [],
  category,
  tags = [],
  readingTime,
  relatedLinks = [],
} = Astro.props;

// Auto-generate related links based on URL structure
const urlPath = new URL(canonical).pathname;
const autoRelatedLinks: Array<{ title: string; url: string; type: string }> = [];

// Add parent hub link (with trailing slashes)
let parentHub: { title: string; url: string } | null = null;

if (urlPath.includes('/ai-security/jailbreaking/')) {
  parentHub = { title: 'AI Security: Jailbreaking', url: '/ai-security/jailbreaking/' };
  autoRelatedLinks.push(
    { title: 'AI Security: Jailbreaking', url: '/ai-security/jailbreaking/', type: 'Hub' },
    { title: 'AATMF Framework', url: '/frameworks/aatmf/', type: 'Framework' }
  );
} else if (urlPath.includes('/ai-security/prompt-injection/')) {
  parentHub = { title: 'AI Security: Prompt Injection', url: '/ai-security/prompt-injection/' };
  autoRelatedLinks.push(
    { title: 'AI Security: Prompt Injection', url: '/ai-security/prompt-injection/', type: 'Hub' },
    { title: 'AATMF Framework', url: '/frameworks/aatmf/', type: 'Framework' }
  );
} else if (urlPath.includes('/ai-security/')) {
  parentHub = { title: 'AI Security Research', url: '/ai-security/' };
  autoRelatedLinks.push(
    { title: 'AI Security Research', url: '/ai-security/', type: 'Hub' },
    { title: 'AATMF Framework', url: '/frameworks/aatmf/', type: 'Framework' }
  );
} else if (urlPath.includes('/security-research/cves/')) {
  parentHub = { title: 'CVE Disclosures', url: '/security-research/cves/' };
  autoRelatedLinks.push(
    { title: 'CVE Disclosures', url: '/security-research/cves/', type: 'Hub' },
    { title: 'Security Research', url: '/security-research/', type: 'Research' }
  );
} else if (urlPath.includes('/security-research/general/')) {
  parentHub = { title: 'Security Research', url: '/security-research/' };
  autoRelatedLinks.push(
    { title: 'Security Research', url: '/security-research/', type: 'Hub' },
    { title: 'CVE Disclosures', url: '/security-research/cves/', type: 'Research' }
  );
} else if (urlPath.includes('/writing/')) {
  parentHub = { title: 'Writing', url: '/writing/' };
  autoRelatedLinks.push(
    { title: 'All Writing', url: '/writing/', type: 'Hub' },
    { title: 'About Kai Aizen', url: '/about/', type: 'Author' }
  );
} else if (urlPath.includes('/frameworks/')) {
  parentHub = { title: 'Security Frameworks', url: '/frameworks/' };
  autoRelatedLinks.push(
    { title: 'Security Frameworks', url: '/frameworks/', type: 'Hub' },
    { title: 'AATMF Framework', url: '/frameworks/aatmf/', type: 'Framework' }
  );
}

// Combine auto-generated and manually provided links
const allRelatedLinks = [...autoRelatedLinks, ...relatedLinks].slice(0, 4);

// Generate breadcrumb from URL
const pathSegments = new URL(canonical).pathname.split('/').filter(Boolean);
const breadcrumbs = [
  { name: 'Home', url: 'https://snailsploit.com' }
];

// Special case mappings for proper casing
const segmentNameMap: Record<string, string> = {
  'ai-security': 'AI Security',
  'cves': 'CVEs',
  'edr-evasion-techniques': 'EDR Evasion Techniques',
  'mcp-threat-analysis': 'MCP Threat Analysis',
  'mcp-security-deep-dive': 'MCP Security Deep Dive',
  'rag-agentic-attack-surface': 'RAG & Agentic Attack Surface',
};

let currentPath = '';
pathSegments.forEach((segment, index) => {
  currentPath += `/${segment}`;
  if (index < pathSegments.length - 1) {
    const name = segmentNameMap[segment] || segment.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    breadcrumbs.push({ name, url: `https://snailsploit.com${currentPath}` });
  }
});

// TechArticle schema - more appropriate for technical security content
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Person",
    "@id": "https://snailsploit.com/#person",
    "name": "Kai Aizen",
    "url": "https://snailsploit.com/about/",
    "sameAs": [
      "https://linkedin.com/in/kaiaizen",
      "https://github.com/SnailSploit"
    ]
  },
  "datePublished": new Date(date).toISOString(),
  "dateModified": dateModified ? new Date(dateModified).toISOString() : new Date(date).toISOString(),
  "mainEntityOfPage": canonical,
  "publisher": {
    "@type": "Organization",
    "name": "SnailSploit",
    "url": "https://snailsploit.com"
  },
  "proficiencyLevel": "Expert",
  "keywords": keywords.join(', ')
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((crumb, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": crumb.name,
    ...(index < breadcrumbs.length - 1 && { "item": crumb.url })
  }))
};

const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  ogType="article"
  ogImage={ogImage || '/images/og-article.png'}
  keywords={keywords}
  schemaData={[articleSchema, breadcrumbSchema]}
  publishedDate={new Date(date).toISOString()}
  modifiedDate={dateModified ? new Date(dateModified).toISOString() : undefined}
>
  <Navigation slot="header" />
  <PersonSchema />

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumbs -->
    <nav class="mb-8 text-sm font-mono" style="color: var(--color-text-muted);">
      {breadcrumbs.map((crumb, index) => (
        <span>
          {index < breadcrumbs.length - 1 ? (
            <a href={crumb.url} class="hover:text-[var(--color-accent-red)] transition-colors">
              {crumb.name}
            </a>
          ) : (
            <span>{title}</span>
          )}
          {index < breadcrumbs.length - 1 && <span class="mx-2">/</span>}
        </span>
      ))}
    </nav>

    <!-- Article Header -->
    <header class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 font-mono" style="color: var(--color-accent-red);">
        {title}
      </h1>

      <div class="flex flex-wrap items-center gap-4 text-sm font-mono mb-6" style="color: var(--color-text-secondary);">
        <time datetime={new Date(date).toISOString()}>{formattedDate}</time>
        {readingTime && <span>• {readingTime}</span>}
        {category && <span>• {category}</span>}
      </div>

      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {tags.map(tag => (
            <span
              class="px-3 py-1 text-xs font-mono rounded"
              style="background-color: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border);"
            >
              {tag}
            </span>
          ))}
        </div>
      )}

      {/* Part of Hub Link */}
      {parentHub && (
        <div class="mt-6 p-4 rounded-lg" style="background-color: var(--color-surface); border: 1px solid var(--color-border);">
          <span class="text-sm" style="color: var(--color-text-muted);">Part of </span>
          <a
            href={parentHub.url}
            class="text-sm font-mono font-semibold hover:underline"
            style="color: var(--color-accent-red);"
          >
            {parentHub.title} →
          </a>
        </div>
      )}
    </header>

    <!-- Article Content -->
    <div class="prose prose-invert prose-lg max-w-none">
      <slot />
    </div>

    <!-- Author Bio -->
    <div class="mt-16 p-6 rounded-lg" style="background-color: var(--color-surface); border: 1px solid var(--color-border);">
      <h3 class="font-mono text-lg font-bold mb-2" style="color: var(--color-accent-red);">
        About the Author
      </h3>
      <p class="text-sm mb-4" style="color: var(--color-text-secondary);">
        <strong>Kai Aizen</strong> is a Security Researcher & 6x CVE Holder, specializing in LLM jailbreaking and adversarial AI.
        Known as "The Jailbreak Chef," Kai is a 6x CVE holder and creator of the AATMF and P.R.O.M.P.T frameworks.
      </p>
      <div class="flex space-x-4">
        <a href="/about" class="text-sm font-mono hover:text-[var(--color-accent-red)] transition-colors" style="color: var(--color-text-secondary);">
          More about Kai →
        </a>
        <a href="https://github.com/SnailSploit" target="_blank" rel="noopener noreferrer" class="text-sm font-mono hover:text-[var(--color-accent-red)] transition-colors" style="color: var(--color-text-secondary);">
          GitHub
        </a>
        <a href="https://linkedin.com/in/kaiaizen" target="_blank" rel="noopener noreferrer" class="text-sm font-mono hover:text-[var(--color-accent-red)] transition-colors" style="color: var(--color-text-secondary);">
          LinkedIn
        </a>
      </div>
    </div>

    <!-- Related Research -->
    {allRelatedLinks.length > 0 && (
      <div class="mt-8 p-6 rounded-lg" style="background-color: var(--color-surface); border: 1px solid var(--color-border);">
        <h3 class="font-mono text-lg font-bold mb-4" style="color: var(--color-accent-red);">
          Related Research
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {allRelatedLinks.map(link => (
            <a
              href={link.url}
              class="group flex items-center gap-3 p-3 rounded transition-all hover:bg-[var(--color-bg)]"
              style="border: 1px solid var(--color-border);"
            >
              {link.type && (
                <span
                  class="px-2 py-0.5 text-xs font-mono rounded shrink-0"
                  style="background-color: var(--color-bg); color: var(--color-text-muted);"
                >
                  {link.type}
                </span>
              )}
              <span class="text-sm font-mono group-hover:text-[var(--color-accent-red)] transition-colors" style="color: var(--color-text-secondary);">
                {link.title}
              </span>
            </a>
          ))}
        </div>
      </div>
    )}
  </article>

  <Footer slot="footer" />
</BaseLayout>

<style>
  /* Prose - optimized for hours of reading */
  .prose {
    color: var(--color-prose, #c8c8c8);
    font-size: 1.125rem;
    line-height: 1.85;
    max-width: 68ch;
    margin: 0 auto;
  }

  .prose h2 {
    color: var(--color-text-primary);
    font-size: 1.75rem;
    font-weight: 700;
    margin-top: 3rem;
    margin-bottom: 1.25rem;
    padding-top: 1rem;
  }

  .prose h3 {
    color: var(--color-text-primary);
    font-size: 1.375rem;
    font-weight: 600;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .prose h4 {
    color: var(--color-text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    margin-bottom: 1.75em;
    line-height: 1.85;
  }

  .prose a {
    color: var(--color-accent-red);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .prose a:hover {
    color: var(--color-accent-red-hover, #ef4444);
  }

  .prose strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }

  .prose code {
    background-color: var(--color-surface);
    padding: 0.2em 0.5em;
    border-radius: 4px;
    font-size: 0.875em;
    color: var(--color-accent-red);
  }

  .prose pre {
    background-color: var(--color-surface);
    padding: 1.5em;
    border-radius: 8px;
    overflow-x: auto;
    border: 1px solid var(--color-border);
    margin: 2rem 0;
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .prose pre code {
    background: none;
    padding: 0;
    color: var(--color-text-primary);
  }

  .prose ul, .prose ol {
    margin: 1.75em 0;
    padding-left: 1.75em;
  }

  .prose li {
    margin-bottom: 0.75em;
    line-height: 1.75;
  }

  .prose li::marker {
    color: var(--color-accent-red);
  }

  .prose blockquote {
    border-left: 3px solid var(--color-accent-red);
    padding: 1rem 1.5rem;
    margin: 2rem 0;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 0 8px 8px 0;
    color: var(--color-prose-muted, #a0a0a0);
    font-style: italic;
  }

  .prose img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2.5rem 0;
  }

  .prose hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 3rem 0;
  }

  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
  }

  .prose th, .prose td {
    padding: 0.75rem 1rem;
    border: 1px solid var(--color-border);
    text-align: left;
  }

  .prose th {
    background: var(--color-surface);
    font-weight: 600;
    color: var(--color-text-primary);
  }
</style>
