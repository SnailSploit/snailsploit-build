---
import BaseLayout from './BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

export interface Props {
  title: string;
  description: string;
  date: string;
  dateModified?: string;
  canonical: string;
  ogImage?: string;
  keywords?: string[];
  category?: string;
  tags?: string[];
  readingTime?: string;
}

const {
  title,
  description,
  date,
  dateModified,
  canonical,
  ogImage,
  keywords = [],
  category,
  tags = [],
  readingTime,
} = Astro.props;

// Generate breadcrumb from URL
const pathSegments = new URL(canonical).pathname.split('/').filter(Boolean);
const breadcrumbs = [
  { name: 'Home', url: 'https://snailsploit.com' }
];

let currentPath = '';
pathSegments.forEach((segment, index) => {
  currentPath += `/${segment}`;
  if (index < pathSegments.length - 1) {
    const name = segment.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    breadcrumbs.push({ name, url: `https://snailsploit.com${currentPath}` });
  }
});

// Article schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "author": {
    "@type": "Person",
    "name": "Kai Aizen",
    "url": "https://snailsploit.com/about"
  },
  "datePublished": new Date(date).toISOString(),
  "dateModified": dateModified ? new Date(dateModified).toISOString() : new Date(date).toISOString(),
  "mainEntityOfPage": canonical,
  "publisher": {
    "@type": "Person",
    "name": "Kai Aizen"
  },
  "keywords": keywords.join(', ')
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((crumb, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": crumb.name,
    ...(index < breadcrumbs.length - 1 && { "item": crumb.url })
  }))
};

const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  ogType="article"
  ogImage={ogImage || '/images/og-article.png'}
  keywords={keywords}
  schemaData={[articleSchema, breadcrumbSchema]}
  date={date}
  dateModified={dateModified}
>
  <Navigation slot="header" />

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumbs -->
    <nav class="mb-8 text-sm font-mono" style="color: var(--color-text-muted);">
      {breadcrumbs.map((crumb, index) => (
        <span>
          {index < breadcrumbs.length - 1 ? (
            <a href={crumb.url} class="hover:text-[var(--color-accent-cyan)] transition-colors">
              {crumb.name}
            </a>
          ) : (
            <span>{title}</span>
          )}
          {index < breadcrumbs.length - 1 && <span class="mx-2">/</span>}
        </span>
      ))}
    </nav>

    <!-- Article Header -->
    <header class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 font-mono" style="color: var(--color-accent-cyan);">
        {title}
      </h1>

      <div class="flex flex-wrap items-center gap-4 text-sm font-mono mb-6" style="color: var(--color-text-secondary);">
        <time datetime={new Date(date).toISOString()}>{formattedDate}</time>
        {readingTime && <span>• {readingTime}</span>}
        {category && <span>• {category}</span>}
      </div>

      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {tags.map(tag => (
            <span
              class="px-3 py-1 text-xs font-mono rounded"
              style="background-color: var(--color-surface); color: var(--color-text-secondary); border: 1px solid var(--color-border);"
            >
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    <!-- Article Content -->
    <div class="prose prose-invert prose-lg max-w-none">
      <slot />
    </div>

    <!-- Author Bio -->
    <div class="mt-16 p-6 rounded-lg" style="background-color: var(--color-surface); border: 1px solid var(--color-border);">
      <h3 class="font-mono text-lg font-bold mb-2" style="color: var(--color-accent-cyan);">
        About the Author
      </h3>
      <p class="text-sm mb-4" style="color: var(--color-text-secondary);">
        <strong>Kai Aizen</strong> is a GenAI Security Researcher at ActiveFence, specializing in LLM jailbreaking and adversarial AI.
        Known as "The Jailbreak Chef," Kai is a 5x CVE holder and creator of the AATMF and P.R.O.M.P.T frameworks.
      </p>
      <div class="flex space-x-4">
        <a href="/about" class="text-sm font-mono hover:text-[var(--color-accent-cyan)] transition-colors" style="color: var(--color-text-secondary);">
          More about Kai →
        </a>
        <a href="https://github.com/SnailSploit" target="_blank" rel="noopener noreferrer" class="text-sm font-mono hover:text-[var(--color-accent-cyan)] transition-colors" style="color: var(--color-text-secondary);">
          GitHub
        </a>
        <a href="https://linkedin.com/in/kaiaizen" target="_blank" rel="noopener noreferrer" class="text-sm font-mono hover:text-[var(--color-accent-cyan)] transition-colors" style="color: var(--color-text-secondary);">
          LinkedIn
        </a>
      </div>
    </div>
  </article>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .prose {
    color: var(--color-text-primary);
  }

  .prose h2 {
    color: var(--color-text-primary);
    font-size: 1.875rem;
    font-weight: 700;
    margin-top: 2em;
    margin-bottom: 1em;
  }

  .prose h3 {
    color: var(--color-text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 1.75em;
    margin-bottom: 0.75em;
  }

  .prose p {
    margin-bottom: 1.25em;
    line-height: 1.75;
  }

  .prose a {
    color: var(--color-accent-cyan);
    text-decoration: underline;
  }

  .prose a:hover {
    color: var(--color-accent-green);
  }

  .prose code {
    background-color: var(--color-surface);
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.9em;
  }

  .prose pre {
    background-color: var(--color-surface);
    padding: 1em;
    border-radius: 0.5rem;
    overflow-x: auto;
    border: 1px solid var(--color-border);
  }

  .prose ul, .prose ol {
    margin: 1.25em 0;
    padding-left: 1.5em;
  }

  .prose li {
    margin-bottom: 0.5em;
  }

  .prose blockquote {
    border-left: 4px solid var(--color-accent-cyan);
    padding-left: 1em;
    margin: 1.5em 0;
    font-style: italic;
    color: var(--color-text-secondary);
  }
</style>
